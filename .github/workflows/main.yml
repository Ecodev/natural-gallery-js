name: main
on: [push, pull_request]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Need all tags to get a version number in-between tags
            - uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'yarn'
            - run: yarn --frozen-lockfile
            - run: yarn build-lib

    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'yarn'
            - run: yarn --frozen-lockfile
            - name: Install Playwright Browsers
              run: yarn playwright install --with-deps
            - name: Setup Ruby for Jekyll
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: '3.0'
                  bundler-cache: true
                  working-directory: docs
            - name: Start Jekyll server
              run: |
                  cd docs
                  bundle exec jekyll serve --detach --port 4000
            - name: Wait for server to be ready
              run: |
                  timeout 30 bash -c 'until curl -f http://localhost:4000/test; do sleep 1; done'
            - run: HEADLESS=1 yarn test

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'yarn'
            - run: yarn --frozen-lockfile
            - run: yarn lint

    prettier:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'yarn'
            - run: yarn --frozen-lockfile
            - run: ./node_modules/.bin/prettier --check .
